<!DOCTYPE html>
<html style="display: none;" lang="zh">
    <head>
    <meta charset="utf-8">
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.5.2 -->
    <script>
        window.materialVersion = "1.5.2"
        // Delete localstorage with these tags
        window.oldVersion = [
            'codestartv1',
            '1.3.4',
            '1.4.0',
            '1.4.0b1',
            '1.5.0'
        ]
    </script>

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">














    <!-- Meta & Info -->
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!-- Title -->
    
    <title>
        
        Maize的小站
    </title>

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" href="/img/favicon.png">

    <meta name="format-detection" content="telephone=no"/>
    <meta name="description" itemprop="description" content="">
    <meta name="keywords" content="">
    <meta name="theme-color" content="#0097A7">

    <!-- Disable Fucking Bloody Baidu Tranformation -->
    <meta http-equiv="Cache-Control" content="no-transform" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import lsloader -->
    <script>(function(){window.lsloader={jsRunSequence:[],jsnamemap:{},cssnamemap:{}};lsloader.removeLS=function(a){try{localStorage.removeItem(a)}catch(b){}};lsloader.setLS=function(a,c){try{localStorage.setItem(a,c)}catch(b){}};lsloader.getLS=function(a){var c="";try{c=localStorage.getItem(a)}catch(b){c=""}return c};versionString="/*"+(window.materialVersion||"unknownVersion")+"*/";lsloader.clean=function(){try{var b=[];for(var a=0;a<localStorage.length;a++){b.push(localStorage.key(a))}b.forEach(function(e){var f=lsloader.getLS(e);if(window.oldVersion){var d=window.oldVersion.reduce(function(g,h){return g||f.indexOf("/*"+h+"*/")!==-1},false);if(d){lsloader.removeLS(e)}}})}catch(c){}};lsloader.clean();lsloader.load=function(f,a,b,d){if(typeof b==="boolean"){d=b;b=undefined}d=d||false;b=b||function(){};var e;e=this.getLS(f);if(e&&e.indexOf(versionString)===-1){this.removeLS(f);this.requestResource(f,a,b,d);return}if(e){var c=e.split(versionString)[0];if(c!=a){console.log("reload:"+a);this.removeLS(f);this.requestResource(f,a,b,d);return}e=e.split(versionString)[1];if(d){this.jsRunSequence.push({name:f,code:e});this.runjs(a,f,e)}else{document.getElementById(f).appendChild(document.createTextNode(e));b()}}else{this.requestResource(f,a,b,d)}};lsloader.requestResource=function(b,e,a,c){var d=this;if(c){this.iojs(e,b,function(h,f,g){d.setLS(f,h+versionString+g);d.runjs(h,f,g)})}else{this.iocss(e,b,function(f){document.getElementById(b).appendChild(document.createTextNode(f));d.setLS(b,e+versionString+f)},a)}};lsloader.iojs=function(d,b,g){var a=this;a.jsRunSequence.push({name:b,code:""});try{var f=new XMLHttpRequest();f.open("get",d,true);f.onreadystatechange=function(){if(f.readyState==4){if((f.status>=200&&f.status<300)||f.status==304){if(f.response!=""){g(d,b,f.response);return}}a.jsfallback(d,b)}};f.send(null)}catch(c){a.jsfallback(d,b)}};lsloader.iocss=function(f,c,h,a){var b=this;try{var g=new XMLHttpRequest();g.open("get",f,true);g.onreadystatechange=function(){if(g.readyState==4){if((g.status>=200&&g.status<300)||g.status==304){if(g.response!=""){h(g.response);a();return}}b.cssfallback(f,c,a)}};g.send(null)}catch(d){b.cssfallback(f,c,a)}};lsloader.iofonts=function(f,c,h,a){var b=this;try{var g=new XMLHttpRequest();g.open("get",f,true);g.onreadystatechange=function(){if(g.readyState==4){if((g.status>=200&&g.status<300)||g.status==304){if(g.response!=""){h(g.response);a();return}}b.cssfallback(f,c,a)}};g.send(null)}catch(d){b.cssfallback(f,c,a)}};lsloader.runjs=function(f,c,e){if(!!c&&!!e){for(var b in this.jsRunSequence){if(this.jsRunSequence[b].name==c){this.jsRunSequence[b].code=e}}}if(!!this.jsRunSequence[0]&&!!this.jsRunSequence[0].code&&this.jsRunSequence[0].status!="failed"){var a=document.createElement("script");a.appendChild(document.createTextNode(this.jsRunSequence[0].code));a.type="text/javascript";document.getElementsByTagName("head")[0].appendChild(a);this.jsRunSequence.shift();if(this.jsRunSequence.length>0){this.runjs()}}else{if(!!this.jsRunSequence[0]&&this.jsRunSequence[0].status=="failed"){var d=this;var a=document.createElement("script");a.src=this.jsRunSequence[0].path;a.type="text/javascript";this.jsRunSequence[0].status="loading";a.onload=function(){d.jsRunSequence.shift();if(d.jsRunSequence.length>0){d.runjs()}};document.body.appendChild(a)}}};lsloader.tagLoad=function(b,a){this.jsRunSequence.push({name:a,code:"",path:b,status:"failed"});this.runjs()};lsloader.jsfallback=function(c,b){if(!!this.jsnamemap[b]){return}else{this.jsnamemap[b]=b}for(var a in this.jsRunSequence){if(this.jsRunSequence[a].name==b){this.jsRunSequence[a].code="";this.jsRunSequence[a].status="failed";this.jsRunSequence[a].path=c}}this.runjs()};lsloader.cssfallback=function(e,c,b){if(!!this.cssnamemap[c]){return}else{this.cssnamemap[c]=1}var d=document.createElement("link");d.type="text/css";d.href=e;d.rel="stylesheet";d.onload=d.onerror=b;var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(d,a)};lsloader.runInlineScript=function(c,b){var a=document.getElementById(b).innerText;this.jsRunSequence.push({name:c,code:a});this.runjs()}})();</script>

    <!-- Import queue -->
    <script>function Queue(){this.dataStore=[];this.offer=b;this.poll=d;this.execNext=a;this.debug=false;this.startDebug=c;function b(e){if(this.debug){console.log("Offered a Queued Function.")}if(typeof e==="function"){this.dataStore.push(e)}else{console.log("You must offer a function.")}}function d(){if(this.debug){console.log("Polled a Queued Function.")}return this.dataStore.shift()}function a(){var e=this.poll();if(e!==undefined){if(this.debug){console.log("Run a Queued Function.")}e()}}function c(){this.debug=true}}var queue=new Queue();</script>

    <!-- Import CSS -->
    
        <style id="material_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_css","/css/material.min.css?Z7a72R1E4SxzBKR/WGctOA==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
        <style id="style_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("style_css","/css/style.min.css?MKetZV3cUTfDxvMffaOezg==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>

        

    

    

    <!-- Config CSS -->

<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
    overflow-x: hidden !important;
  }
  
  code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


<!-- Import Font -->
<!-- Import Roboto -->

    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">


<!-- Import Material Icons -->


    <style id="material_icons"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_icons","/css/material-icons.css?pqhB/Rd/ab0H2+kZp0RDmw==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>




    <!-- Import jQuery -->
    
        <script>lsloader.load("jq_js","/js/jquery.min.js?qcusAULNeBksqffqUM2+Ig==", true)</script>
    

    <!-- WebAPP Icons -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Maize的小站">
    <meta name="msapplication-starturl" content="http://maizegithub.github.io/2017/12/04/swift中的动与静/">
    <meta name="msapplication-navbutton-color" content="#0097A7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Maize的小站">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!-- Site Verification -->
    
    

    <!-- RSS -->
    

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://maizegithub.github.io/2017/12/04/swift中的动与静/">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Maize的小站">
    <meta property="og:image" content="/img/favicon.png">
    <meta property="og:description" content="">
    

    
        <meta property="article:published_time" content="Mon Dec 04 2017 19:04:48 GMT+0800">
        <meta property="article:modified_time" content="Sun Dec 31 2017 12:11:16 GMT+0800">
    

    <!-- The Twitter Card protocol -->
    <meta name="twitter:card" content="summary_large_image">

    <!-- Add canonical link for SEO -->
    
        <link rel="canonical" href="http://maizegithub.github.io/2017/12/04/swift中的动与静/index.html" />
    

    <!-- Structured-data for SEO -->
    
        


<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage": "http://maizegithub.github.io/2017/12/04/swift中的动与静/index.html",
    "headline": "",
    "datePublished": "Mon Dec 04 2017 19:04:48 GMT+0800",
    "dateModified": "Sun Dec 31 2017 12:11:16 GMT+0800",
    "author": {
        "@type": "Person",
        "name": "Maize",
        "image": {
            "@type": "ImageObject",
            "url": "/img/avatar.png"
        },
        "description": "Hi, nice to meet you"
    },
    "publisher": {
        "@type": "Organization",
        "name": "Maize的小站",
        "logo": {
            "@type":"ImageObject",
            "url": "/img/favicon.png"
        }
    },
    "keywords": "",
    "description": "",
}
</script>


    

    <!-- Analytics -->
    
    
    

    <!-- Custom Head -->
    

</head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->


    <!-- Left aligned menu below button -->
    
    
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#从一个小问题讲起"><span class="post-toc-number">1.</span> <span class="post-toc-text">从一个小问题讲起</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#TableView-转发器"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">TableView 转发器</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Module-通信"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">Module 通信</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Direct-Table-amp-Message"><span class="post-toc-number">2.</span> <span class="post-toc-text">Direct, Table &amp; Message</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Message"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">Message</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Table"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">Table</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Direct"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">Direct</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#In-Swift"><span class="post-toc-number">2.4.</span> <span class="post-toc-text">In Swift</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#回到问题"><span class="post-toc-number">3.</span> <span class="post-toc-text">回到问题</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#一个小问题"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">一个小问题</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#TableView-转发器-1"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">TableView 转发器</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Module-通信-1"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">Module 通信</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#one-more-thing"><span class="post-toc-number">3.4.</span> <span class="post-toc-text">one more thing</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#参考资料"><span class="post-toc-number">4.</span> <span class="post-toc-text">参考资料</span></a></li></ol>
    </ul>
    




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script type="text/ls-javascript" id="post-thumbnail-script">
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').attr('data-original', '/img/random/material-' + randomNum + '.png');
    $('.post_thumbnail-random').addClass('lazy');
</script>

        
    
            <p class="article-headline-p">
                
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.png" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>Maize</strong>
        <span>12月 04, 2017</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    

    <!-- Share -->
    
        <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=&url=http://maizegithub.github.io/2017/12/04/swift中的动与静/index.html&pic=http://maizegithub.github.io/img/favicon.png&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=&url=http://maizegithub.github.io/2017/12/04/swift中的动与静/index.html&via=Maize" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://maizegithub.github.io/2017/12/04/swift中的动与静/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://maizegithub.github.io/2017/12/04/swift中的动与静/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    

    <!-- Share Telegram -->
    
</ul>

    
</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <p>[TOC]</p>
<p><strong>Swift</strong> 相比于其它语言有一个很好的特性, 开发者不仅可以给协议增加接口, 还能进一步给协议提供方法实现. 通过这个 <em>Feature</em>, 开发者可以使用<strong>组合</strong>而非<strong>继承</strong>的思想来设计对象, 也就是所谓的<strong>面向接口编程</strong>.</p>
<p>但是需要明确的是, 这个特性并不是可以随心所欲的加以使用. 在日常 <em>coding</em> 中偶尔能遇到某个行为被编译器报错, 又或者编译通过后表现出预期外行为. 这篇文章整理了我在开发过程中遇到的一些问题, 并通过 <em>Swift</em> 的派发机制来解释这些行为背后的原因.</p>
<h2 id="从一个小问题讲起"><a href="#从一个小问题讲起" class="headerlink" title="从一个小问题讲起"></a>从一个小问题讲起</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">MyProtocol</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">testFuncA</span><span class="params">()</span></span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">MyProtocol</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">testFuncA</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"MyProtocol's testFuncA"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  	<span class="function"><span class="keyword">func</span> <span class="title">testFuncB</span><span class="params">()</span></span> &#123;</span><br><span class="line">    	<span class="built_in">print</span>(<span class="string">"MyProtocol's testFuncB"</span>)</span><br><span class="line">  	&#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看到上面的例子, 我们定义了一个协议 <em>MyProtocol</em>, 该协议存在一个必须实现的方法 <em>testFuncA</em>.</p>
<p>此外, 我们通过扩展为改协议提供 <em>testFuncA</em> 的默认实现, 并额外的提供了一个名为 <em>testFuncB</em> 方法的默认实现.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span>: <span class="title">MyProtocol</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">testFuncA</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"MyClass's testFuncA"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">testFuncB</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"MyClass's testFuncB"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着定义一个类 <em>MyClass</em>, 该类提供 <em>testFuncA</em>, <em>testFuncA</em> 的方法实现.</p>
<p>那么问题来了:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> object: <span class="type">MyProtocol</span> = <span class="type">MyClass</span>()</span><br><span class="line">object.testFuncA()</span><br><span class="line">object.testFuncB()</span><br></pre></td></tr></table></figure>
<p>对声明为协议类型的对象分别调用 <em>testFuncA</em>, <em>testFuncA</em>, 实际调用的方法究竟是 <em>MyClass</em> 提供的呢, 还是 <em>MyProtocol</em> 提供的默认实现?</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Output:</span><br><span class="line">MyClass's testFuncA</span><br><span class="line">MyProtocol's testFuncB</span><br></pre></td></tr></table></figure>
<p>可以看到, <strong>调用 <em>MyProtocol</em> 内声明的方法时, 最终调用到了 <em>MyClass</em> 内部的实现, 而调用方法未在协议内声明时, 实际调用到了协议扩展中提供的实现.</strong></p>
<p>这个问题并不罕见, 开发者可能已经见怪不怪. 不过莫急, 在解释背后的原因之前, 我还想抛出两个问题.</p>
<h3 id="TableView-转发器"><a href="#TableView-转发器" class="headerlink" title="TableView 转发器"></a>TableView 转发器</h3><p>这是我在开发中遇到的一个问题.</p>
<p>随着版本迭代, 一些页面里的内容越来越多. 为了避免 <em>Massive View Controller</em> 问题, 我将页面中的内容划分为一个个的 <em>Module</em>, <em>Module</em> 负责管理各个模块的 <em>Model</em> 和 <em>View</em>. 整个页面以 <em>TableView</em> 的形式组织, 由最外面的容器 <em>ViewController</em> <strong>转发 <em>TableView</em> 的数据源代理方法到各个 <em>Module</em> 中去</strong>.</p>
<p>出于面向协议的设计思路, 首先想到的是将上述黑体字所描述的功能通过协议扩展的方式实现, 这样一来对象只需要遵循我所设计的协议就可以获得<strong>转发 <em>TableView</em> 的数据源代理方法到各个 <em>Module</em> </strong>的功能.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">ModuleContainerProtocol</span> <span class="title">where</span> <span class="title">Self</span>: <span class="title">UITableViewDataSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView, numberOfRowsInSection section: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> modules.<span class="built_in">reduce</span>(<span class="number">0</span>) &#123; $<span class="number">0</span> + $<span class="number">0</span>.numberOfSections?(<span class="keyword">in</span>: <span class="keyword">self</span>.tableView) ?? <span class="number">1</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView, cellForRowAt indexPath: IndexPath)</span></span> -&gt; <span class="type">UITableViewCell</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> (module, section) = convertToTargetModule(with: indexPath.section)</span><br><span class="line">        <span class="keyword">return</span> module.tableView(tableView, cellForRowAt: <span class="type">IndexPath</span>(row: indexPath.row, section: section))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法里的实现是往各个 <em>Module</em> 转发消息的实现, 可以忽略.</p>
<p>问题是: <strong>可以在 <em>Swift</em> 的协议扩展里为 Objective-C 的协议提供方法实现吗?</strong></p>
<h3 id="Module-通信"><a href="#Module-通信" class="headerlink" title="Module 通信"></a>Module 通信</h3><p>这个同样是在开发 <em>Module</em> 过程中遇到的问题.</p>
<p>在某些业务场景下需要 <em>Module</em> 向主容器发送一些特定的业务消息, 主容器以遵循 <em>ModuleContainer</em> 协议的泛型的形式被 <em>Module</em> 弱引用. </p>
<p>我为 <em>ModuleContainer</em> 添加一个方法, <em>Module</em> 通过这个方法可以向主容器发送特定的业务消息. 这个方法从功能上看明显是可选的, 但是我不想添加 <em>optional</em> 关键字(还得将协议声明为 <em>@objc</em>, 成本较大), 于是我想了一个”巧妙”的方法:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">ModuleContainer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">customMessage</span><span class="params">(<span class="number">_</span> key: ModuleContainerCustomKey, parameters: [Any]?)</span></span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">ModuleContainer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">customMessage</span><span class="params">(<span class="number">_</span> key: ModuleContainerCustomKey, parameters: [Any]?)</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 该类实现 TableView 转发器功能</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseModuleController</span>: <span class="title">UIViewController</span>, <span class="title">ModuleContainer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyViewController</span>: <span class="title">BaseModuleController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">customMessage</span><span class="params">(<span class="number">_</span> key: ModuleContainerCustomKey, parameters: [Any]?)</span></span> &#123;</span><br><span class="line">        <span class="comment">// 接受消息并处理</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在为 <em>ModuleContainer</em> 声明方法的同时, 在协议扩展里为其提供默认实现.</p>
<p>在需要该方法的业务层, 比如 <em>MyViewController</em> 中, 再覆盖该方法的默认实现. 或许你已经发现了, 缺少 <em>override</em> 关键字也能编译通过.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> moduleContainer: <span class="type">ModuleCOntainer</span></span><br><span class="line">moduleContainer.customMessage(someKey, parameters: <span class="literal">nil</span>)</span><br></pre></td></tr></table></figure>
<p>那么问题来了, 与最开始的一个例子一样,  <em>customMessage</em> 是声明在协议内部的, 差别在于<strong>提供覆盖实现的类并不是遵循这个协议的类而是该类的子类</strong>. 这样的调用方式最终能否调用到 <em>MyViewController</em> 提供的实现呢?</p>
<p>剧透一下, 不能, 原因稍后再讲.</p>
<p>在这个基础上我又做了一些改进, 我在 <em>BaseModuleController</em> 里提供协议的实现, 在 <em>MyViewController</em> 中再覆盖其父类的实现, 这样终于能见到熟悉的 <em>override</em> 关键字了.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 该类实现 TableView 转发器功能</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseModuleController</span>: <span class="title">UIViewController</span>, <span class="title">ModuleContainer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">customMessage</span><span class="params">(<span class="number">_</span> key: ModuleContainerCustomKey, parameters: [Any]?)</span></span> &#123;</span><br><span class="line">        <span class="comment">// Inspired by subclass if needed.</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyViewController</span>: <span class="title">BaseModuleController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">customMessage</span><span class="params">(<span class="number">_</span> key: ModuleContainerCustomKey, parameters: [Any]?)</span></span> &#123;</span><br><span class="line">        <span class="comment">// 接受消息并处理</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>最后一个问题, 这样能达到目的吗?</strong></p>
<p>在解释问题之前, 首先简短的介绍一下各种语言常见的三种函数派发方式.</p>
<h2 id="Direct-Table-amp-Message"><a href="#Direct-Table-amp-Message" class="headerlink" title="Direct, Table &amp; Message"></a>Direct, Table &amp; Message</h2><p>不少 <em>Swift</em> 开发人员都有过 <em>Objective-C</em> 的开发经历, 而 <em>Objective-C</em> 最让人印象深刻的, 就是那奇怪的语法和基于消息的函数派发方式了.</p>
<h3 id="Message"><a href="#Message" class="headerlink" title="Message"></a>Message</h3><p>基于消息是最为灵活的一种派发方式, 最大限度的允许开发者在运行时修改函数的行为. </p>
<p>以 <em>Objective-C</em> 为例, 所有对象都拥有一个 <em>isa</em> 指针, 可以通过该指针找到对应的方法列表. 方法列表中存储着该类实现的方法(不包括父类实现的方法)以及指向父类方法列表的指针. 当消息派发时, 会沿着类的方法列表到父类的方法列表(<em>Super</em> 指针)的顺序寻找方法实现.</p>
<p>在 <em>Swift</em> 中, <em>Dynamic</em> 关键字可以为方法加上运行时特性.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySuperClass</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">dynamic</span> <span class="function"><span class="keyword">func</span> <span class="title">testFuncA</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line">    <span class="keyword">dynamic</span> <span class="function"><span class="keyword">func</span> <span class="title">testFuncB</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span>: <span class="title">MySuperClass</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">testFuncB</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line">    <span class="keyword">dynamic</span> <span class="function"><span class="keyword">func</span> <span class="title">testFuncC</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:center">MyClass</th>
<th style="text-align:center">MySuperClass</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Super</td>
<td style="text-align:center">testFuncA</td>
</tr>
<tr>
<td style="text-align:center">testFuncB(New)</td>
<td style="text-align:center">testFuncB</td>
</tr>
<tr>
<td style="text-align:center">testFuncC</td>
</tr>
</tbody>
</table>
<h3 id="Table"><a href="#Table" class="headerlink" title="Table"></a>Table</h3><p>函数表是最为常见的函数派发方式. </p>
<p>同 <em>Message Dispatch</em> 类似, 所有类也会维护一个自己的函数表, 不同的是所有未被复写的父类所实现的函数地址都会拷贝在这个表中, 而不是由一个指向父类方法表的指针替代. 由于少了一步指针寻址步骤, 在派发效率上要比基于消息的派发高效, 但是在灵活性上打了折扣.</p>
<p>在 <em>Swift</em> 中, 该表被称为 <em>Witness Table</em>.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySuperClass</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">testFuncA</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">testFuncB</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span>: <span class="title">MySuperClass</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">testFuncB</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">testFuncC</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:center">MyClass</th>
<th style="text-align:center">MySuperClass</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">testFuncA</td>
<td style="text-align:center">testFuncA</td>
</tr>
<tr>
<td style="text-align:center">testFuncB(New)</td>
<td style="text-align:center">testFuncB</td>
</tr>
<tr>
<td style="text-align:center">testFuncC</td>
</tr>
</tbody>
</table>
<h3 id="Direct"><a href="#Direct" class="headerlink" title="Direct"></a>Direct</h3><p>直接派发是效率最高的, 在编译阶段就能确定调用的函数地址. 但是缺乏了动态特性, 也不支持继承.</p>
<h3 id="In-Swift"><a href="#In-Swift" class="headerlink" title="In Swift"></a>In Swift</h3><p><em>Swift</em> 支持了全部三种派发方式, 根据具体的使用场景和关键字决定派发方式.</p>
<p>下面是搜集到的一位开发者整理的 <em>Swift3</em> 下派发方式的测试结果. 之后我会将 <em>Swift4</em> 下的测试结果更新在这里.</p>
<table>
<thead>
<tr>
<th></th>
<th>Initial Declaration</th>
<th>Extension</th>
</tr>
</thead>
<tbody>
<tr>
<td>Value Type</td>
<td>Direct</td>
<td>Direct</td>
</tr>
<tr>
<td>Protocol</td>
<td>Table</td>
<td>Direct</td>
</tr>
<tr>
<td>Class</td>
<td>Table</td>
<td>Direct</td>
</tr>
<tr>
<td>NSObject SubClass</td>
<td>Table</td>
<td>Message</td>
</tr>
</tbody>
</table>
<p>以及该位开发者在 <em>Swift3</em> 下的总结:</p>
<ul>
<li>值类型总是会使用直接派发, 简单易懂</li>
<li>而协议和类的 extension 都会使用直接派发</li>
<li><code>NSObject</code> 的 extension 会使用消息机制进行派发</li>
<li><code>NSObject</code> 声明作用域里的函数都会使用函数表进行派发.</li>
<li>协议里声明的, 并且带有默认实现的函数会使用函数表进行派发</li>
</ul>
<p>需要注意的是, 尽管开发者文档<strong>表明了部分场景的派发情况, 但是实际的派发方式可能会被优化</strong>(<a href="https://developer.apple.com/swift/blog/?id=27" target="_blank" rel="noopener">Increasing Performance by Reducing Dynamic Dispatch</a>). 比如 <strong>@objc</strong> 关键字能为方法添加运行时特性, 但是在使用的时候仍有可能被优化成 <em>static dispatch</em>. 且除了 <strong>final</strong>,<strong>private</strong> 一些关键字能让编译器在编译期就能确定调用的函数地址外, <em>Whole Module Optimization</em> 选项能让绝大多数未被重写的方法得到编译器的优化.</p>
<h2 id="回到问题"><a href="#回到问题" class="headerlink" title="回到问题"></a>回到问题</h2><h3 id="一个小问题"><a href="#一个小问题" class="headerlink" title="一个小问题"></a>一个小问题</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">MyProtocol</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">testFuncA</span><span class="params">()</span></span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">MyProtocol</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">testFuncA</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"MyProtocol's testFuncA"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  	<span class="function"><span class="keyword">func</span> <span class="title">testFuncB</span><span class="params">()</span></span> &#123;</span><br><span class="line">    	<span class="built_in">print</span>(<span class="string">"MyProtocol's testFuncB"</span>)</span><br><span class="line">  	&#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>testFuncA</em> 和 <em>testFuncB</em> 虽然都在 <em>MyProtocol</em> 的扩展中提供了默认实现, 但是:</p>
<ul>
<li><em>testFuncA</em> 的默认实现注册到了 <em>MyProtocol</em> 的函数表中.</li>
<li>testFuncB 的函数实现将会被直接派发.</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> object: <span class="type">MyProtocol</span> = <span class="type">MyClass</span>()</span><br><span class="line">object.testFuncA()</span><br><span class="line">object.testFuncB()</span><br></pre></td></tr></table></figure>
<p>因此, <em>MyClass</em> 在实现 <em>testFuncA</em> 的时候, 也将这个实现注册到了 <em>MyProtocol</em> 的函数表中. 在调用 <em>testFuncA</em> 的时候, 会在函数表中查找对应的实现. 而在编译的时候就已经将 <em>MyProtocol</em> 中关于 <em>testFuncB</em> 的函数地址作为派发的地址给确定下来了, 根本不关心 <em>object</em> 的具体类型. </p>
<p>因此在调用的时候 <em>testFuncA</em> 使用的是 <em>MyClass</em> 的实现, 而 <em>testFuncB</em> 使用的是 <em>MyProtocol</em> 的实现.</p>
<h3 id="TableView-转发器-1"><a href="#TableView-转发器-1" class="headerlink" title="TableView 转发器"></a>TableView 转发器</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">ModuleContainerProtocol</span> <span class="title">where</span> <span class="title">Self</span>: <span class="title">UITableViewDataSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView, numberOfRowsInSection section: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> modules.<span class="built_in">reduce</span>(<span class="number">0</span>) &#123; $<span class="number">0</span> + $<span class="number">0</span>.numberOfSections?(<span class="keyword">in</span>: <span class="keyword">self</span>.tableView) ?? <span class="number">1</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView, cellForRowAt indexPath: IndexPath)</span></span> -&gt; <span class="type">UITableViewCell</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> (module, section) = convertToTargetModule(with: indexPath.section)</span><br><span class="line">        <span class="keyword">return</span> module.tableView(tableView, cellForRowAt: <span class="type">IndexPath</span>(row: indexPath.row, section: section))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>UITableViewDataSource</em> 是<em>OC</em> 中的协议, 使用 <em>Message Dispatch</em> 的派发方式. 而 <em>protocol</em> 的 <em>extension</em> 中定义的方法却是 <em>objc_msgSend()</em> 方法不可见的, 因此在编译器会报错.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Non</span>-'<span class="meta">@objc</span>' method 'tableView(<span class="number">_</span>:numberOfRowsInSection:)' does not satisfy requirement of '<span class="meta">@objc</span>' <span class="class"><span class="keyword">protocol</span> '<span class="title">UITableViewDataSource</span>'</span></span><br></pre></td></tr></table></figure>
<p>既然是对 <em>OC</em> 不可见, 加上 <em>@objc</em> 关键字能否满足需求呢?</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@objc</span> can only be used with members of classes, <span class="meta">@objc</span> protocols, and concrete extensions of classes</span><br></pre></td></tr></table></figure>
<p>很遗憾, 目前 <em>Swift</em> 不支持这种操作, 不过不排除未来支持的可能性, 参见<a href="https://stackoverflow.com/questions/39487168/non-objc-method-does-not-satisfy-optional-requirement-of-objc-protocol" target="_blank" rel="noopener">Non-‘@objc’ method does not satisfy optional requirement of ‘@objc’ protocol</a>.</p>
<p>同理, 直接为 <em>UITableViewDataSource</em> 为原方法提供默认实现也是不可取的, 添加的方法在 <em>Swift</em> 侧可以调用, 但是在 <em>OC</em> 测(也就是 <em>UIKit</em> 内的实现) 是完全不可见这个方法的.</p>
<h3 id="Module-通信-1"><a href="#Module-通信-1" class="headerlink" title="Module 通信"></a>Module 通信</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">ModuleContainer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">customMessage</span><span class="params">(<span class="number">_</span> key: ModuleContainerCustomKey, parameters: [Any]?)</span></span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">ModuleContainer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">customMessage</span><span class="params">(<span class="number">_</span> key: ModuleContainerCustomKey, parameters: [Any]?)</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 该类实现 TableView 转发器功能</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseModuleController</span>: <span class="title">UIViewController</span>, <span class="title">ModuleContainer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyViewController</span>: <span class="title">BaseModuleController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">customMessage</span><span class="params">(<span class="number">_</span> key: ModuleContainerCustomKey, parameters: [Any]?)</span></span> &#123;</span><br><span class="line">        <span class="comment">// 接受消息并处理</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>customMessage</em> 方法由于声明在 <em>ModuleContainer</em> 的原始定义内, 因此派发方式为 <em>Table Dispatch</em>. 需要注意的是, 在 <em>BaseModuleController</em> 内提供的 <em>customMessage</em> 实现才会注册进 <em>ModuleContainer</em> 的函数表, 也就是说 <em>MyViewController</em> 内的 <em>CustomMessage</em> 方法并不在函数表中.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> moduleContainer: <span class="type">ModuleCOntainer</span></span><br><span class="line">moduleContainer.customMessage(someKey, parameters: <span class="literal">nil</span>)</span><br></pre></td></tr></table></figure>
<p>所以这样调用的结果自然是会调用到 <em>ModuleContainer</em> 所提供的 <em>customMessage</em> 默认实现了.</p>
<h3 id="one-more-thing"><a href="#one-more-thing" class="headerlink" title="one more thing"></a>one more thing</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 该类实现 TableView 转发器功能</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseModuleController</span>: <span class="title">UIViewController</span>, <span class="title">ModuleContainer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">customMessage</span><span class="params">(<span class="number">_</span> key: ModuleContainerCustomKey, parameters: [Any]?)</span></span> &#123;</span><br><span class="line">        <span class="comment">// Inspired by subclass if needed.</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyViewController</span>: <span class="title">BaseModuleController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">customMessage</span><span class="params">(<span class="number">_</span> key: ModuleContainerCustomKey, parameters: [Any]?)</span></span> &#123;</span><br><span class="line">        <span class="comment">// 接受消息并处理</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>经过修改后, <em>BaseModuleController</em> 提供了 <em>customMessage</em> 的实现并注册到了 <em>ModuleContainer</em> 的函数表里. </p>
<p>然后通过 <em>override</em> 关键字实现再往 <em>ModuleContainer</em> 的函数表里添加一个实现?</p>
<p>答案是可以的, 但是需要注意的是, 一般开发者习惯将遵循某个协议的方法单独卸载 <em>extension</em> 中, 使得代码分布更加清晰.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">BaseModuleController</span>: <span class="title">ModuleContainer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">customMessage</span><span class="params">(<span class="number">_</span> key: ModuleContainerCustomKey, parameters: [Any]?)</span></span> &#123;</span><br><span class="line">        <span class="comment">// Inspired by subclass if needed.</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是在 <em>swift</em> 中:</p>
<ul>
<li>不得在 <em>extension</em> 中 <em>override</em> 已有的方法.</li>
<li>不得 <em>override</em> <em>extension</em> 里的方法.</li>
</ul>
<p>所以, 想要达到目的, 还是老老实实的忍住代码洁癖, 将 <em>customMessage</em> 放到 <em>BaseModuleController</em> 的初始声明里面去吧╮(╯_╰)╭</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://cocoacasts.com/what-does-the-dynamic-keyword-mean-in-swift-3/" target="_blank" rel="noopener">what-does-the-dynamic-keyword-mean-in-swift-3</a></li>
<li><a href="https://developer.apple.com/swift/blog/?id=27" target="_blank" rel="noopener">Increasing Performance by Reducing Dynamic Dispatch</a></li>
<li><a href="https://www.raizlabs.com/dev/2016/12/swift-method-dispatch/" target="_blank" rel="noopener">Method Dispatch in Swift</a></li>
<li><a href="https://stackoverflow.com/questions/39487168/non-objc-method-does-not-satisfy-optional-requirement-of-objc-protocol" target="_blank" rel="noopener">Non-‘@objc’ method does not satisfy optional requirement of ‘@objc’ protocol</a></li>
</ul>

        
    

    
</div>


                

                <!-- Post Comments -->
                
                    
                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2018/01/02/Pod 维护心得/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2017/12/04/奇怪的 if let/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.png" alt="Maize's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        youremail@email.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="#" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2018/01/">一月 2018<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/12/">十二月 2017<span class="sidebar_archives-count">3</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    

    <!-- Pages  -->
    

    <!-- Article Number  -->
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->

    <div class="sidebar-divider"></div>


<!-- Theme Material -->

    <a href="https://github.com/viosey/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
            主题 - Material
            <span class="sidebar-badge badge-circle">i</span>
        </div>
    </a>


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div id="back-to-top" class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
        <a href="https://twitter.com/twitter" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-twitter">
                <span class="visuallyhidden">Twitter</span>
            </button><!--
     --></a>
    

    <!-- Facebook -->
    
        <a href="https://www.facebook.com/facebook" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-facebook">
                <span class="visuallyhidden">Facebook</span>
            </button><!--
     --></a>
    

    <!-- Google + -->
    
        <a href="https://www.google.com/" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-gplus">
                <span class="visuallyhidden">Google Plus</span>
            </button><!--
     --></a>
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
    
    <!-- V2EX -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©<script type="text/javascript">var fd = new Date();document.write("&nbsp;" + fd.getFullYear() + "&nbsp;");</script>Maize的小站
            
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import JS File -->

    <script>lsloader.load("lazyload_js","/js/lazyload.min.js?1BcfzuNXqV+ntF6gq+5X3Q==", true)</script>



    <script>lsloader.load("js_js","/js/js.min.js?V/53wGualMuiPM3xoetD5Q==", true)</script>



    <script>lsloader.load("np_js","/js/nprogress.js?pl3Qhb9lvqR1FlyLUna1Yw==", true)</script>


<script type="text/ls-javascript" id="NProgress-script">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>













<!-- UC Browser Compatible -->
<script>
	var agent = navigator.userAgent.toLowerCase();
	if(agent.indexOf('ucbrowser')>0) {
		document.write('<link rel="stylesheet" href="/css/uc.css">');
	   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
	}
</script>

<!-- Import prettify js  -->



<!-- Window Load -->
<!-- add class for prettify -->
<script type="text/ls-javascript" id="window-load">
    $(window).on('load', function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });

    
    
</script>

<!-- MathJax Load-->


<!-- Bing Background -->


<script type="text/ls-javascript" id="lazy-load">
    // Offer LazyLoad
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    // Start Queue
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

<!-- Custom Footer -->



<script>
    (function(){
        var scriptList = document.querySelectorAll('script[type="text/ls-javascript"]')

        for (var i = 0; i < scriptList.length; ++i) {
            var item = scriptList[i];
            lsloader.runInlineScript(item.id,item.id);
        }
    })()
console.log('\n %c © Material Theme | Version: 1.5.2 | https://github.com/viosey/hexo-theme-material %c \n', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-left-radius:5px;border-bottom-left-radius:5px;', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-right-radius:5px;border-bottom-right-radius:5px;');
</script>

                </main>
            </div>
        </body>
    
</html>
